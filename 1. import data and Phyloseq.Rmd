---
title: "Import data for Build Phyloseq-Tao Wen 2023"
author: "Hendra"
date: "2025-01-10"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# install.packages("BiocManager")
library(BiocManager)
# install("phyloseq")
# install("ggtree")
library(phyloseq)
library(Biostrings)
# ?read.delim
# ?read.table
# ?read.csv
library(ape)
# ?read.tree
library(ggtree)
# ?read.tree
# ?read_tre
# ?readDNAStringSet
library(plyr)

library(reshape2)  # Untuk melt dari reshape2
# atau
library(data.table)  # Untuk melt dari data.table
```

#-------------------------------------------PHYLOSEQ-ALL--------------------------------------------------#

```{r}
otu = read.delim("D:/S3-KU/Rice seed analysis/Phyloseq/OTU table new.txt",row.names = 1)
tax = read.delim("D:/S3-KU/Rice seed analysis/Phyloseq/Taxonomy table.txt",row.names = 1)
map = read.delim("D:/S3-KU/Rice seed analysis/Phyloseq/rice-seed-metadataR.txt",row.names = 1)
map$ID = row.names(map)

head(map)
```

```{r}
head(tax)
```


```{r}
library(ggtree)
tree  = read_tree("D:/S3-KU/Rice seed analysis/Phyloseq/Phylogenetic tree new.nwk")

library(Biostrings)
rep = readDNAStringSet("D:/S3-KU/Rice seed analysis/Phyloseq/sequences data.fasta")
```

```{r}
library(phyloseq)

ps = phyloseq(sample_data(map),
              otu_table(as.matrix(otu), taxa_are_rows=TRUE), 
              tax_table(as.matrix(tax)),
              phy_tree(tree),
              refseq(rep)
              )
ps
```

```{r}
saveRDS(ps,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Physeq-all.rds")
```

##---------------------------------------SUB-SET METADATA--------------------------------------

```{r}
psorigin <- subset_samples(ps,  Source == "Origin")
```

```{r}
saveRDS(ps,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Physeq-origin.rds")
```


```{r}
pscultur <- subset_samples(ps,  Source == "Culturable")
```

```{r}
saveRDS(ps,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Physeq-cultur.rds")
```


#-----------------------------------KONVERSI KE ASV names-------------------------------#

```{r}
asv_names <- paste0("ASV_", seq(1:ntaxa(ps)))  # Buat nama baru
```

```{r}
# Simpan nama lama OTU
old_names <- taxa_names(ps)

# Ganti nama di setiap komponen phyloseq
taxa_names(ps) <- asv_names  # Ganti nama utama

# Perbarui nama di setiap komponen phyloseq
otu_table(ps) <- otu_table(ps)[asv_names, ]  # Pastikan urutannya benar
tax_table(ps) <- tax_table(ps)[asv_names, ]
phy_tree(ps) <- prune_taxa(asv_names, phy_tree(ps))  # Jika ada pohon
refseq(ps) <- refseq(ps)[asv_names]
```

```{r}
new_refseq <- refseq(ps)  # Ambil refseq lama
names(new_refseq) <- asv_names  # Ganti nama menjadi ASV
new_refseq <- Biostrings::DNAStringSet(new_refseq)  # Konversi ulang agar sesuai format
```

```{r}
Biostrings::writeXStringSet(new_refseq, filepath = "new_refseq_output.fasta")
```

```{r}
ps_asv <- phyloseq(
  sample_data(ps),
  otu_table(ps),
  tax_table(ps),
  phy_tree(ps),
  new_refseq  # Masukkan refseq yang sudah diperbarui
)

ps_asv
```

```{r}
all(taxa_names(ps_asv) == names(refseq(ps_asv)))  # Harus TRUE
```

```{r}
tax_table(ps_asv)
```


```{r}
otu_table(ps_asv)
```


```{r}
saveRDS(ps_asv,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Phyasv-all.rds")
```

```{r}
ps_asv_origin <- subset_samples(ps_asv,  Source == "Origin")
```

```{r}
saveRDS(ps_asv_origin,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Phyasv-origin.rds")
```

```{r}
ps_asv_cultur <- subset_samples(ps_asv,  Source == "Culturable")
```


```{r}
saveRDS(ps_asv_cultur,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Phyasv-cultur.rds")
```

















## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


#-----------------------------GANTI TAXA ASV-----------------#

```{r}
otu = read.delim("D:/S3-KU/Rice seed analysis/Phyloseq/ASVs_table.txt",row.names = 1)
tax = read.delim("D:/S3-KU/Rice seed analysis/Phyloseq/Taxonomy_ASVss.txt",row.names = 1)
map = read.delim("D:/S3-KU/Rice seed analysis/Phyloseq/rice-seed-metadataR.txt",row.names = 1)
map$ID = row.names(map)

head(map)
```


```{r}
library(phyloseq)

pso = phyloseq(sample_data(map),
              otu_table(as.matrix(otu), taxa_are_rows=TRUE), 
              tax_table(as.matrix(tax))
              )
pso
```

```{r}
psori <- subset_samples(pso,  Source == "Origin")
```

```{r}
saveRDS(psori,"D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Physeqasvori.rds")
```





