---
title: "ANCOM"
author: "Hendra"
---

Reference:
The R script used in this study was adapted from Lin (2024) with minor modifications, as provided in the ANCOMBC Bioconductor package documentation 
(https://www.bioconductor.org/packages/release/bioc/html/ANCOMBC. DOI: 10.18129/B9.bioc.ANCOMBC).

-----------------------------------------------------------------------------------------------------------------
library(BiocManager)
library(phyloseq)
library(ANCOMBC)
library(dplyr)
-------------------------------------------------------------------------------------------------------------------

psseed_origin = base::readRDS("D:/S3-KU/Rice seed analysis/Phyloseq/New Phylo/Physeq-origin.rds")
sample_data(psseed_origin)

# Subset to baseline
pseq = phyloseq::subset_samples(psseed_origin, Source == "Origin")

# Re-code the location group
meta_data = microbiome::meta(pseq)
meta_data$Location = recode(meta_data$Location,
                       obese = "LamLukKa_PathumThani",
                       severeobese = "LamLukKa_PathumThani",
                       morbidobese = "LamLukKa_PathumThani")

# as the reference level, use:
meta_data$Location = factor(meta_data$Location, levels = c("NangRong_BuriRam", "LahanSai_BuriRam", "LamLukKa_PathumThani"))
# You can verify the change by checking:
# levels(meta_data$Location)

colnames(meta_data)

# Create the region variable
meta_data$Variety = recode(as.character(meta_data$Variety),
                          KDML105 = "NE", PTT1 = "NE",
                          .missing = "unknown")

phyloseq::sample_data(pseq) = meta_data

sample_variables(pseq)

# Subset to specific Locations
pseq <- phyloseq::subset_samples(
  pseq,
  Location %in% c("NangRong_BuriRam", "LahanSai_BuriRam", "LamLukKa_PathumThani")
)

# Discard "EE" as it contains only 1 subject
# Discard subjects with missing values of region
pseq <- phyloseq::subset_samples(
  pseq,
  !Variety %in% c("EE", "unknown")
)

print(pseq)
-------------------------------------------------------------------------------------------------------------------

library(phyloseq)

# Convert counts to relative abundance
rel_abund <- transform_sample_counts(ps, function(x) x / sum(x))

# Calculate mean relative abundance per taxon
mean_abund <- taxa_sums(rel_abund) / nsamples(ps)

# Keep only taxa with mean relative abundance > 1%
high_abund_taxa <- names(mean_abund[mean_abund > 0.01])
ps_high <- prune_taxa(high_abund_taxa, ps)


pseq_perm = ps_high
meta_data_perm = microbiome::meta(pseq_perm)

phyloseq::sample_data(pseq_perm) = meta_data_perm

output = ancombc2(data = pseq_perm, tax_level = "Genus",
                  fix_formula = "Location", rand_formula = NULL,
                  p_adj_method = "holm", pseudo_sens = TRUE,
                  prv_cut = 0, lib_cut = 1000, s0_perc = 0.05,
                  group = "Location", struc_zero = TRUE, neg_lb = TRUE)
-------------------------------------------------------------------------------------------------------------------
library(dplyr)
res_perm = output$res %>%
    dplyr::transmute(taxon = taxon,
                     p = p_LocationLamLukKa_PathumThani,
                     ss_pass = passed_ss_LocationLamLukKa_PathumThani) %>%
  rowwise() %>%
  mutate(
      p_update = case_when(
          # For taxa with significant p-values that failed the sensitivity analysis,
          # we assign a random value uniformly drawn from the range [0.05, 1].
          p < 0.05 & ss_pass == FALSE ~ runif(1, min = 0.05, max = 1),
    TRUE ~ p 
  )) %>%
  ungroup()

library(tidyr)

df_p = res_perm %>%
  dplyr::select(p, p_update) %>%
  pivot_longer(cols = p:p_update, names_to = "type", values_to = "value") 
df_p$type = recode(df_p$type, 
                   `p` = "ANCOM-BC2 (Without Sensitivity Analysis)", 
                   `p_update` = "ANCOM-BC2 (With Sensitivity Analysis)")

library(ggplot2)

num_bins = 30
fig_p = df_p %>%
  ggplot(aes(x = value, fill = type)) +
  geom_histogram(position = "identity", alpha = 0.5, bins = num_bins) +
  geom_hline(yintercept = phyloseq::ntaxa(pseq_perm)/num_bins, linetype = "dashed") +
  theme_minimal() +
  labs(title = "Distribution of P-values",
       x = "P-value",
       y = "Frequency",
       fill = NULL,
       color = NULL) +
    theme_bw() + 
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.minor.y = element_blank(),
          legend.position = "bottom")
fig_p
-------------------------------------------------------------------------------------------------------------------

===================================
# 1. Global test (Location-set)
===================================
library(phyloseq)
library(ANCOMBC)
library(dplyr)
library(ggplot2)

# Run ANCOMBC2 - Global analysis "Location"
output1 <- ancombc2(
  data = pseq,
  tax_level = "Genus",
  fix_formula = "Location",
  group = "Location",
  global = TRUE,
  pairwise = FALSE,
  p_adj_method = "holm",
  prv_cut = 0.10,
  lib_cut = 1000,
  s0_perc = 0.05,
  struc_zero = TRUE,
  neg_lb = TRUE,
  alpha = 0.05
)

res_global = output1$res_global
# display the first 10 rows
head(res_global, 10)

# or display all in the console
print(res_global)

library(DT)

# using dplyr
dplyr::glimpse(res_global)

datatable(
  res_global,
  caption = "ANCOM-BC2 Global Test: Differential Genus by Location",
  options = list(pageLength = 20, scrollX = TRUE)
)

View(res_global)

install.packages("openxlsx")

library(openxlsx)

# Save the res_global results to Excel
#write.xlsx(res_global, "ANCOMBC2_GlobalTest.xlsx")
-------------------------------------------------------------------------------------------------------------------

library(ggplot2)
# Asumsi res_global adalah data.frame hasil ANCOM-BC2 global test
res_plot <- res_global %>%
  dplyr::mutate(
    neg_log_q = -log10(q_val),
    signif = ifelse(diff_robust_abn, "Significant & Robust", "Not Significant")
  )

ggplot(res_plot, aes(x = W, y = neg_log_q, color = signif, label = taxon)) +
  geom_point(size = 4, alpha = 1) +
  geom_text(data = subset(res_plot, q_val < 0.05), 
            aes(label = taxon, color = "black", size = 12), 
            vjust = -1, size = 4) +
  scale_color_manual(values = c("Significant & Robust" = "#D55E00", "Not Significant" = "#0072B2")) +
  labs(
    title = "ANCOM-BC2 Global Test: Volcano Plot",
    x = "W-statistic",
    y = "-log10(q-value)",
    color = "Genus status"
  ) +
  theme_minimal(base_size = 16)

library(ggplot2)

# Asumsi res_global adalah data.frame hasil ANCOM-BC2 global test
res_plot <- res_global %>%
  dplyr::mutate(
    neg_log_q = -log10(q_val),
    signif = ifelse(diff_robust_abn, "Significant & Robust", "Not Significant")
  )

p1 <- ggplot(res_plot, aes(x = W, y = neg_log_q, color = signif, label = taxon)) +
  geom_point(size = 5, alpha = 0.9) +
  geom_text(data = subset(res_plot, q_val < 0.05), 
            aes(label = ""), 
            vjust = -1, size = 3) +
  scale_color_manual(values = c("Significant & Robust" = "#D55E00", "Not Significant" = "#0072B2")) +
  labs(
    title = "ANCOM-BC2 Global Test: Volcano Plot",
    x = "W-statistic",
    y = "-log10(q-value)",
    color = ""
  ) +
  theme_minimal(base_size = 16)

print(p1)

#save
ggsave("Globaltest_ancombc2.png", p1, width = 7, height = 7, dpi = 1000)
-------------------------------------------------------------------------------------------------------------------

===================================
# 2. PAIRWISE test (Location sample set)
===================================
library(phyloseq)
library(ANCOMBC)
library(dplyr)
library(ggplot2)

sample_data(psseed_origin)

# Subset to baseline
psori = phyloseq::subset_samples(psseed_origin, Source == "Origin")
sample_data(psori)

# Run ANCOM-BC2 with multiple pairwise comparisons
out <- ancombc2(
  data = psori,
  assay_name = "counts",
  tax_level = "Genus",
  fix_formula = "Location",     # fixed effect
  rand_formula = NULL,          # if no random effect
  p_adj_method = "holm",        # p-value adjustment method
  pseudo = 0,
  pseudo_sens = TRUE,
  prv_cut = 0.10,
  lib_cut = 1000,
  s0_perc = 0.05,
  alpha = 0.05,
  n_cl = 1,
  group = "Location",
  global = TRUE,                # perform global test
  pairwise = TRUE,              # enable pairwise test
  dunnet = FALSE,
  trend = FALSE
)

library(dplyr)
library(tidyr)

str(out$res_pair)

res_pair <- out$res_pair

# Specify the corresponding columns
lfc_1vs2 <- "lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani"
q_1vs2   <- "q_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani"

lfc_2vs3 <- "lfc_LocationNangRong_BuriRam"
q_2vs3   <- "q_LocationNangRong_BuriRam"

# Extract results with threshold |lfc| >= 2 and q < 0.05
res_1vs2 <- res_pair %>%
  select(taxon, lfc = all_of(lfc_1vs2), q_val = all_of(q_1vs2)) %>%
  filter(!is.na(lfc), q_val < 0.05, abs(lfc) >= 2) %>%
  mutate(comparison = "NangRong vs LamLukKa")

res_2vs3 <- res_pair %>%
  select(taxon, lfc = all_of(lfc_2vs3), q_val = all_of(q_2vs3)) %>%
  filter(!is.na(lfc), q_val < 0.05, abs(lfc) >= 2) %>%
  mutate(comparison = "NangRong vs LahanSai")

# Combined
sig_res <- bind_rows(res_1vs2, res_2vs3)

print(sig_res)
-------------------------------------------------------------------------------------------------------------------
# ===== significant Barplot at genus level =====
ggplot(sig_res, aes(x = reorder(taxon, lfc), y = lfc, fill = comparison)) +
  geom_col(position = position_dodge()) +
  geom_hline(yintercept = 0, color = "black") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Significant Genera (|lfc| â‰¥ 2, q<0.05)",
       x = "Genus", y = "Log Fold Change")

# Plot 1: NangRong vs LamLukKa
p1 <- ggplot(res_1vs2, aes(x = reorder(taxon, lfc), y = lfc)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = 0, color = "black") +
  coord_flip() +
  theme_minimal() +
  labs(title = "NangRong vs LamLukKa",
       x = "Genus", y = "Log Fold Change")

# Plot 2: NangRong vs LahanSai
p2 <- ggplot(res_2vs3, aes(x = reorder(taxon, lfc), y = lfc)) +
  geom_col(fill = "tomato") +
  geom_hline(yintercept = 0, color = "black") +
  coord_flip() +
  theme_minimal() +
  labs(title = "NangRong vs LahanSai",
       x = "Genus", y = "Log Fold Change")

p1
p2
-------------------------------------------------------------------------------------------------------------------

library(dplyr)
library(tidyr)
library(ggplot2)

res_pair = out$res_pair

str(out$res_pair)

## --- Filter genus yang signifikan di salah satu perbandingan
df_fig_pair1 = res_pair %>%
  dplyr::filter(diff_LocationNangRong_BuriRam == 1 |
                  diff_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani == 1) %>%
  dplyr::mutate(
    lfc1 = ifelse(diff_LocationNangRong_BuriRam == 1,
                  round(lfc_LocationNangRong_BuriRam, 2), 0),
    lfc2 = ifelse(diff_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani == 1,
                  round(lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani, 2), 0)
  ) %>%
  tidyr::pivot_longer(cols = lfc1:lfc2, names_to = "group", values_to = "value") %>%
  dplyr::arrange(taxon)

df_fig_pair2 = res_pair %>%
  dplyr::filter(diff_LocationNangRong_BuriRam == 1 |
                  diff_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani == 1) %>%
  dplyr::mutate(
    lfc1 = ifelse(diff_robust_LocationNangRong_BuriRam, "aquamarine3", "black"),
    lfc2 = ifelse(diff_robust_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani, "aquamarine3", "black")
  ) %>%
  tidyr::pivot_longer(cols = lfc1:lfc2, names_to = "group", values_to = "color") %>%
  dplyr::arrange(taxon)

df_fig_pair = df_fig_pair1 %>%
  dplyr::left_join(df_fig_pair2, by = c("taxon", "group"))

# Ubah label group
df_fig_pair$group = recode(df_fig_pair$group,
                           `lfc1` = "NangRong vs LahanSai",
                           `lfc2` = "NangRong vs LamLukKa")
df_fig_pair$group = factor(df_fig_pair$group,
                           levels = c("NangRong vs LahanSai",
                                      "NangRong vs LamLukKa"))

## --- Heatmap-style tile plot
lo = floor(min(df_fig_pair$value))
up = ceiling(max(df_fig_pair$value))
mid = (lo + up)/2

fig_tile = df_fig_pair %>%
  ggplot(aes(x = group, y = taxon, fill = value)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       na.value = "white", midpoint = mid, limit = c(lo, up),
                       name = "LFC") +
  geom_text(aes(label = value, color = color), size = 3) +
  scale_color_identity(guide = FALSE) +
  labs(x = NULL, y = NULL,
       title = "Log fold changes across Location groups") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

fig_tile
-------------------------------------------------------------------------------------------------------------------

## --- Barplot per perbandingan
# NangRong vs LahanSai
barplot1 = res_pair %>%
  filter(diff_LocationNangRong_BuriRam == 1) %>%
  ggplot(aes(x = reorder(taxon, lfc_LocationNangRong_BuriRam),
             y = lfc_LocationNangRong_BuriRam)) +
    geom_col(fill = "blue") +
  coord_flip() +
  theme_minimal() +
  labs(title = "NangRong vs LamLukKa", x = "Genus", y = "Log Fold Change")
  
barplot1

# NangRong vs LamLukKa
barplot2 = res_pair %>%
  filter(diff_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani == 1) %>%
  ggplot(aes(x = reorder(taxon, lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani),
             y = lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani)) +
  geom_col(fill = "tomato") +
  coord_flip() +
  theme_minimal() +
  labs(title = "NangRong vs LamLukKa", x = "Genus", y = "Log Fold Change")

barplot2

## --- Volcano plot per perbandingan
# NangRong vs LahanSai
volcano1 = res_pair %>%
  ggplot(aes(x = lfc_LocationNangRong_BuriRam,
             y = -log10(q_LocationNangRong_BuriRam))) +
  geom_point(aes(color = diff_LocationNangRong_BuriRam)) +
  scale_color_manual(values = c("FALSE"="grey", "TRUE"="red")) +
  theme_minimal() +
  labs(title = "Volcano Plot: NangRong vs LahanSai",
       x = "Log Fold Change", y = "-log10(q-value)")

volcano1

# NangRong vs LamLukKa
volcano2 = res_pair %>%
  ggplot(aes(x = lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani,
             y = -log10(q_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani))) +
  geom_point(aes(color = diff_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani)) +
  scale_color_manual(values = c("FALSE"="grey", "TRUE"="red")) +
  theme_minimal() +
  labs(title = "Volcano Plot: NangRong vs LamLukKa",
       x = "Log Fold Change", y = "-log10(q-value)")

volcano2

res_pair <- out$res_pair

lfc_cols <- grep("^lfc_", names(res_pair), value = TRUE)
q_cols   <- grep("^q_", names(res_pair), value = TRUE)

message("LF C columns found:\n", paste(lfc_cols, collapse = "\n"))
message("Q value columns found:\n", paste(q_cols, collapse = "\n"))


lfc_LocationNangRong_BuriRam  => NangRong vs LahanSai (karena LahanSai adalah reference)
lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani => NangRong vs LamLukKa

col_lfc_nang_vs_lahan <- "lfc_LocationNangRong_BuriRam"
col_q_nang_vs_lahan   <- sub("^lfc_", "q_", col_lfc_nang_vs_lahan)

col_lfc_nang_vs_lam   <- "lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani"
col_q_nang_vs_lam     <- sub("^lfc_", "q_", col_lfc_nang_vs_lam)

stopifnot(col_lfc_nang_vs_lahan %in% names(res_pair))
stopifnot(col_q_nang_vs_lahan %in% names(res_pair))
stopifnot(col_lfc_nang_vs_lam %in% names(res_pair))
stopifnot(col_q_nang_vs_lam %in% names(res_pair))

# 3) Ekstrak tabel dengan threshold q < 0.05 dan |lfc| >= 2
sig_nang_vs_lahan <- res_pair %>%
  select(taxon, lfc = all_of(col_lfc_nang_vs_lahan), q = all_of(col_q_nang_vs_lahan),
         diff = starts_with("diff_") ) %>%   # optional: ambil kolom diff_ kalau ada
  filter(!is.na(lfc), q < 0.05, abs(lfc) >= 1) %>%
  arrange(desc(abs(lfc))) %>%
  mutate(comparison = "NangRong vs LahanSai")

sig_nang_vs_lam <- res_pair %>%
  select(taxon, lfc = all_of(col_lfc_nang_vs_lam), q = all_of(col_q_nang_vs_lam),
         diff = starts_with("diff_") ) %>%
  filter(!is.na(lfc), q < 0.05, abs(lfc) >= 1) %>%
  arrange(desc(abs(lfc))) %>%
  mutate(comparison = "NangRong vs LamLukKa")

sig_all <- bind_rows(sig_nang_vs_lahan, sig_nang_vs_lam)

write.csv(sig_all, file = "significant_genera_pairs.csv", row.names = FALSE)

## === Barplot NangRong vs LahanSai ===
if (nrow(sig_nang_vs_lahan) > 0) {
  p_bar1 <- ggplot(sig_nang_vs_lahan,
                   aes(x = reorder(taxon, lfc),
                       y = lfc,
                       fill = lfc > 0)) +
    geom_col() +
    scale_fill_manual(values = c("TRUE" = "#E69F00",   # enriched
                                 "FALSE" = "#0072B2"), # depleted
                      labels = c("Depleted", "Enriched"),
                      name = "Status") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    coord_flip() +
    theme_minimal(base_size = 12) +
    labs(title = "NangRong vs LahanSai",
         x = "Genus",
         y = "Log Fold Change")
  print(p_bar1)
}

## === Barplot NangRong vs LamLukKa ===
if (nrow(sig_nang_vs_lam) > 0) {
  p_bar2 <- ggplot(sig_nang_vs_lam,
                   aes(x = reorder(taxon, lfc),
                       y = lfc,
                       fill = lfc > 0)) +
    geom_col() +
    scale_fill_manual(values = c("TRUE" = "#E69F00",   # enriched
                                 "FALSE" = "#0072B2"), # depleted
                      labels = c("Depleted", "Enriched"),
                      name = "Status") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    coord_flip() +
    theme_minimal(base_size = 12) +
    labs(title = "NangRong vs LamLukKa",
         x = "Genus",
         y = "Log Fold Change")
  print(p_bar2)
}
-------------------------------------------------------------------------------------------------------------------

# NangRong vs LahanSai
p_volcano1 <- res_pair %>%
  mutate(x = .data[[col_lfc_nang_vs_lahan]],
         y = -log10(.data[[col_q_nang_vs_lahan]]),
         sig = (!is.na(x) & !is.na(y) & (.data[[col_q_nang_vs_lahan]] < 0.05 & abs(x) >= 2))) %>%
  ggplot(aes(x = x, y = y, color = sig)) +
  geom_point() +
  scale_color_manual(values = c("FALSE" = "grey50", "TRUE" = "red")) +
  theme_minimal() +
  labs(title = "Volcano: NangRong vs LahanSai", x = "Log Fold Change", y = "-log10(q-value)")
print(p_volcano1)

# Untuk NangRong vs LamLukKa
p_volcano2 <- res_pair %>%
  mutate(x = .data[[col_lfc_nang_vs_lam]],
         y = -log10(.data[[col_q_nang_vs_lam]]),
         sig = (!is.na(x) & !is.na(y) & (.data[[col_q_nang_vs_lam]] < 0.05 & abs(x) >= 2))) %>%
  ggplot(aes(x = x, y = y, color = sig)) +
  geom_point() +
  scale_color_manual(values = c("FALSE" = "grey50", "TRUE" = "red")) +
  theme_minimal() +
  labs(title = "Volcano: NangRong vs LamLukKa", x = "Log Fold Change", y = "-log10(q-value)")
print(p_volcano2)
-------------------------------------------------------------------------------------------------------------------

library(dplyr)
library(ggplot2)

res_pair <- out$res_pair

# Subset the genus label (abbrev. & italic)
clean_taxon <- function(x) {
  x <- gsub("Bacteria_ Proteobacteria_ Gammaproteobacteria_ Burkholderiales_ Comamonadaceae_",
            "Comamonadaceae", x)
  # Just pick up the last name "_"
  x <- sapply(strsplit(x, "_"), tail, 1)
  # buat expression bold + italic
  paste0("italic('", x, "')")
}

## === NangRong vs LahanSai ===
res_nang_vs_lahan <- res_pair %>%
  filter(q_LocationNangRong_BuriRam < 0.05) %>%
  select(taxon,
         lfc = lfc_LocationNangRong_BuriRam,
         q   = q_LocationNangRong_BuriRam,
         se  = se_LocationNangRong_BuriRam) %>%
  mutate(taxon_clean = clean_taxon(taxon))

if (nrow(res_nang_vs_lahan) > 0) {
  p_nang_vs_lahan <- ggplot(res_nang_vs_lahan,
                            aes(x = reorder(taxon_clean, lfc),
                                y = lfc,
                                fill = lfc > 0)) +
    geom_col() +
    geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se),
                  width = 0.01, color = "black") +
    scale_fill_manual(values = c("TRUE" = "#E69F00", "FALSE" = "#0072B2"),
                      labels = c("Depleted", "Enriched"),
                      name = "") +
    geom_hline(yintercept = 0, linetype = "solid") +
    coord_flip() +
    theme_minimal(base_size = 12) +
    scale_x_discrete(labels = parse(text = levels(reorder(res_nang_vs_lahan$taxon_clean,
                                                          res_nang_vs_lahan$lfc)))) +
    labs(title = "NangRong vs LahanSai", x = "Genus", y = "Log Fold Change") +
     theme(
  axis.title.x = element_text(face = "bold", size = 12),  # Log Fold Change
  axis.title.y = element_text(face = "bold", color = "black", size = 12)   # Genus
)
  print(p_nang_vs_lahan)
}

## === NangRong vs LamLukKa ===
res_nang_vs_lam <- res_pair %>%
  filter(q_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani < 0.05) %>%
  select(taxon,
         lfc = lfc_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani,
         q   = q_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani,
         se  = se_LocationNangRong_BuriRam_LocationLamLukKa_PathumThani) %>%
  mutate(taxon_clean = clean_taxon(taxon))

if (nrow(res_nang_vs_lam) > 0) {
  p_nang_vs_lam <- ggplot(res_nang_vs_lam,
                          aes(x = reorder(taxon_clean, lfc),
                              y = lfc,
                              fill = lfc > 0)) +
    geom_col() +
    geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se),
                  width = 0.01, color = "black") +
    scale_fill_manual(values = c("TRUE" = "#E69F00", "FALSE" = "#0072B2"),
                      labels = c("Depleted", "Enriched"),
                      name = "") +
    geom_hline(yintercept = 0, linetype = "solid") +
    coord_flip() +
    theme_minimal(base_size = 12) +
    scale_x_discrete(labels = parse(text = levels(reorder(res_nang_vs_lam$taxon_clean,
                                                          res_nang_vs_lam$lfc)))) +
    labs(title = "NangRong vs LamLukKa", x = "Genus", y = "Log Fold Change") +
     theme(
  axis.title.x = element_text(face = "bold", size = 12),  # Log Fold Change
  axis.title.y = element_text(face = "bold", color = "black", size = 12)   # Genus
)
  print(p_nang_vs_lam)
}

## === LamLukKa vs LahanSai ===
res_lam_vs_lahan <- res_pair %>%
  filter(q_LocationLamLukKa_PathumThani < 0.05) %>%
  select(taxon,
         lfc = lfc_LocationLamLukKa_PathumThani,
         q   = q_LocationLamLukKa_PathumThani,
         se  = se_LocationLamLukKa_PathumThani) %>%
  mutate(taxon_clean = clean_taxon(taxon))

if (nrow(res_lam_vs_lahan) > 0) {
  p_lam_vs_lahan <- ggplot(res_lam_vs_lahan,
                           aes(x = reorder(taxon_clean, lfc),
                               y = lfc,
                               fill = lfc > 0)) +
    geom_col() +
    geom_errorbar(aes(ymin = lfc - se, ymax = lfc + se),
                  width = 0.01, color = "black") +
    scale_fill_manual(values = c("TRUE" = "#E69F00", "FALSE" = "#0072B2"),
                      labels = c("Depleted", "Enriched"),
                      name = "Status") +
    geom_hline(yintercept = 0, linetype = "33") +
    coord_flip() +
    theme_minimal(base_size = 12) +
    scale_x_discrete(labels = parse(text = levels(reorder(res_lam_vs_lahan$taxon_clean,
                                                          res_lam_vs_lahan$lfc)))) +
    labs(title = "LamLukKa vs LahanSai", x = "Genus", y = "Log Fold Change") +
     theme(
  axis.title.x = element_text(face = "bold", size = 12),  # Log Fold Change
  axis.title.y = element_text(face = "bold", size = 12)   # Genus
)
  print(p_lam_vs_lahan)
}

ggsave("pairtest_ancombc2_nangrong-lahansai.png", p_nang_vs_lahan, width = 6, height = 4, dpi = 1000)
ggsave("pairtest_ancombc2_nangrong-lamlukka.png", p_nang_vs_lam, width = 6, height = 5, dpi = 1000)
-------------------------------------------------------------------------------------------------------------------
#--------Volcano Plot ------#

library(dplyr)
library(ggplot2)
library(ggrepel)

# === Volcano Plots ===

plot_volcano <- function(df, title) {
  ggplot(df, aes(x = lfc, y = -log10(q), color = lfc > 0, label = taxon_clean)) +
    geom_point(size = 3, alpha = 0.8) +
    geom_text_repel(size = 4, color = "black", max.overlaps = 20) +
    scale_color_manual(values = c("TRUE" = "#D55E00",   # merah colorblind-friendly
                                  "FALSE" = "#0072B2"), # biru colorblind-friendly
                       labels = c("Depleted", "Enriched"),
                       name = "Status") +
    theme_minimal(base_size = 12) +
    labs(title = title, x = "Log Fold Change", y = "-log10(q-value)") +
    theme(plot.title = element_text(hjust = 0.5))
}

## === NangRong vs LahanSai ===
if (nrow(res_nang_vs_lahan) > 0) {
  v_nang_vs_lahan <- plot_volcano(res_nang_vs_lahan, "Volcano: NangRong vs LahanSai")
  print(v_nang_vs_lahan)
}

## === NangRong vs LamLukKa ===
if (nrow(res_nang_vs_lam) > 0) {
  v_nang_vs_lam <- plot_volcano(res_nang_vs_lam, "Volcano: NangRong vs LamLukKa")
  print(v_nang_vs_lam)
}

## === LamLukKa vs LahanSai ===
if (nrow(res_lam_vs_lahan) > 0) {
  v_lam_vs_lahan <- plot_volcano(res_lam_vs_lahan, "Volcano: LamLukKa vs LahanSai")
  print(v_lam_vs_lahan)
}
-------------------------------------------------------------------------------------------------------------------


